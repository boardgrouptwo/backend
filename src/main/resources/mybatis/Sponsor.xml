<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.khcare.spring">
    <insert id="sponsorFormInsert" parameterType="map">
        INSERT INTO sponsor
            (user_id, spon_number ,spon_date, spon_huwon, spon_money, spon_pay, spon_open, spon_content) VALUES
            (#{user_id}, #{spon_number}, #{spon_date}, #{spon_huwon}, #{spon_money}, #{spon_pay}, #{spon_open}, #{spon_content})
    </insert>

    <select id="sponsorList" parameterType="map" resultType="map">
        SELECT user_id,
               SUM(spon_money) AS spon_money,
               (SELECT spon_content
                FROM sponsor
                WHERE user_id = A.user_id
                ORDER BY spon_date DESC
                                  LIMIT 1) AS spon_content,
                   CASE
                     WHEN EXISTS (SELECT 1 FROM sponsor WHERE user_id = A.user_id AND spon_open = '공개') THEN '공개'
                     ELSE '비공개'
                    END AS spon_open
        FROM sponsor A
        GROUP BY user_id
        ORDER BY spon_money DESC;
    </select>

    <!-- spon_no값 확인 -->
    <select id="sponsorNo" resultType="map">
        SELECT spon_no FROM sponsor
        ORDER BY spon_no DESC LIMIT 1;
    </select>

    <!-- 카카오페이 결제 내역 추가 -->
    <insert id="sponsorInsertKakao" parameterType="com.khcare.spring.dto.KakaoPayDto">
        INSERT INTO sponsor (
                                user_id
                                , spon_number
                                , spon_date
                                , spon_huwon
                                , spon_money
                                , spon_pay
                                , spon_open
                                , spon_content
                                , spon_tid
                            ) VALUES (
                                #{partner_user_id}
                                , #{partner_order_id}
                                , #{approved_at}
                                , "일반 후원"
                                , #{total_amount}
                                , #{spon_pay}
                                , #{spon_open}
                                , #{spon_content}
                                , #{tid}
                            )
    </insert>

    <!--  사용자 총 후원 금액  -->
    <select id="sponsorUserSum" parameterType="java.util.HashMap" resultType="int">
        SELECT SUM(spon_money) AS spon_sum FROM sponsor
        WHERE user_id = #{user_id};
    </select>
</mapper>